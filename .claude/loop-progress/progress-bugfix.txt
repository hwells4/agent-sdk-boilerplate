# Progress: bugfix

Verify: (none)

## Codebase Patterns
- Convex pagination: Use `paginationOptsValidator` from `convex/server` and `.paginate(args.paginationOpts)` instead of `.collect()` with manual slicing
- Return type for paginated queries: `PaginationResult<Doc<"tableName">>` with `{page, continueCursor, isDone}`
- Empty result for unauthorized access: `{ page: [], continueCursor: "", isDone: true }`
- Denormalization: For efficient queries that filter on parent entity fields, denormalize the field onto the child table
- Composite indexes: Use `.index("name", [field1, field2])` for queries filtering on multiple fields
- Race condition prevention: Re-fetch document state immediately before update, not at authorization check time
- Graceful terminal state handling: Use `skipTerminalStates` option for cron jobs that may race with normal completion
- FK validation in internal mutations: Always validate referenced entities exist before insert, include ID in error message
- Consistency validation: When denormalizing, validate that child entity's FK matches parent entity's expected value
- Privilege escalation prevention: For role changes that involve admin privileges, require owner role (not just admin)

---

## 2026-01-09 - claude-agent-sdk-experiments-yb3
- Fixed pagination memory issue by replacing `.collect()` with `.paginate()`
- Files changed:
  - `convex/sandboxRuns.ts`: Updated `listByWorkspace` to use built-in `.paginate()`
  - `convex/artifacts.ts`: Updated `listByRun` to use built-in `.paginate()`
  - `convex/artifacts.ts`: Updated `listPending` to use iterative pagination (full fix requires workspaceId denormalization from separate story)
- Learnings: Convex's `.paginate()` returns `PaginationResult` with different field names (`page` not `items`, `continueCursor` not `cursor`)
- Gotchas: `listPending` cannot be fully O(page_size) without schema change - artifacts need `workspaceId` field for efficient filtering
---

## 2026-01-09 - claude-agent-sdk-experiments-2rb
- Denormalized workspaceId onto artifacts table to eliminate N+1 query in listPending
- Files changed:
  - `convex/schema.ts`: Added `workspaceId` field and `by_workspace_review` composite index
  - `convex/artifacts.ts`: Updated `create` to populate workspaceId from sandboxRun access
  - `convex/artifacts.ts`: Updated `internalCreate` to accept workspaceId parameter
  - `convex/artifacts.ts`: Simplified `listPending` to single index query (was 60+ lines of iterative pagination)
  - `convex/artifacts.ts`: Added `backfillWorkspaceId` internal mutation for existing data
- Learnings: Type assertion `(artifact as { workspaceId?: unknown }).workspaceId` needed for backfill of optional-in-runtime field
- Performance: Query now O(1) database reads regardless of pending artifact count
---

## 2026-01-09 - claude-agent-sdk-experiments-xoi
- Fixed race condition in concurrent status updates
- Files changed:
  - `convex/sandboxRuns.ts`: Refactored `performSandboxRunUpdate` to re-fetch document state before patching
  - `convex/sandboxRuns.ts`: Added `UpdateResult` type with `{updated, skipped, reason}`
  - `convex/sandboxRuns.ts`: Added `skipTerminalStates` option to `internalUpdate` for graceful cron handling
  - `convex/actions/killIdleSandboxes.ts`: Use `skipTerminalStates: true`, track skipped count in logs
- Learnings: Authorization checks may stale-read document state; always re-fetch before state-dependent operations
- Gotchas: Cron job queries can return sandboxes that complete between query and update - handle with `skipTerminalStates`
---

## 2026-01-09 - claude-agent-sdk-experiments-i8i
- Added FK validation to internal mutations to prevent orphaned records
- Files changed:
  - `convex/sandboxRuns.ts`: Added workspace existence check in `internalCreate`
  - `convex/artifacts.ts`: Added sandbox run and workspace existence checks in `internalCreate`
  - `convex/artifacts.ts`: Added workspace consistency check (sandbox run must belong to specified workspace)
- Learnings: Internal mutations bypass auth but still need data integrity checks
- Error messages include the invalid ID for debugging: `Workspace not found: ${args.workspaceId}`
---

## 2026-01-09 - claude-agent-sdk-experiments-94t
- Fixed admin role escalation vulnerability in workspaceMembers.ts
- Files changed:
  - `convex/workspaceMembers.ts`: updateRole now requires owner for admin promotion/demotion
  - `convex/workspaceMembers.ts`: removeMember now requires owner to remove admin members
- Security: Only owners can change admin privileges (promote to admin, demote from admin, or remove admin)
- Pattern: Capture `requireWorkspaceMembership` return value to check caller's role for secondary authorization
- Error messages follow existing pattern: "Unauthorized: only owners can..."
---

