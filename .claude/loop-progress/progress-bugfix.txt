# Progress: bugfix

Verify: (none)

## Codebase Patterns
- Convex pagination: Use `paginationOptsValidator` from `convex/server` and `.paginate(args.paginationOpts)` instead of `.collect()` with manual slicing
- Return type for paginated queries: `PaginationResult<Doc<"tableName">>` with `{page, continueCursor, isDone}`
- Empty pagination result: Use `emptyPaginationResult<Doc<"tableName">>()` from `./lib/pagination` instead of inline object literal
- Denormalization: For efficient queries that filter on parent entity fields, denormalize the field onto the child table
- Composite indexes: Use `.index("name", [field1, field2])` for queries filtering on multiple fields
- Race condition prevention: Re-fetch document state immediately before update, not at authorization check time
- Graceful terminal state handling: Use `skipTerminalStates` option for cron jobs that may race with normal completion
- FK validation in internal mutations: Always validate referenced entities exist before insert, include ID in error message
- Consistency validation: When denormalizing, validate that child entity's FK matches parent entity's expected value
- Privilege escalation prevention: For role changes that involve admin privileges, require owner role (not just admin)
- Batch operations for cascade deletion: Use Promise.all with proper ordering (children before parents) to avoid timeout
- Type derivation: Use `Infer<typeof validator>` from convex/values to derive types from validators, re-export for backward compatibility
- Authorization standardization: Use `getUserMembership` helper for queries (returns null), `requireWorkspaceMembership` for mutations (throws); always use `by_workspace_user` composite index
- Composite index range queries: Use `.eq(field1, value).lt(field2, cutoff)` to filter at index level; avoids fetching all records and filtering in memory
- String length validation: Use helper functions in validators.ts to enforce length limits; validate early (fail fast before DB queries)

---

## 2026-01-09 - claude-agent-sdk-experiments-yb3
- Fixed pagination memory issue by replacing `.collect()` with `.paginate()`
- Files changed:
  - `convex/sandboxRuns.ts`: Updated `listByWorkspace` to use built-in `.paginate()`
  - `convex/artifacts.ts`: Updated `listByRun` to use built-in `.paginate()`
  - `convex/artifacts.ts`: Updated `listPending` to use iterative pagination (full fix requires workspaceId denormalization from separate story)
- Learnings: Convex's `.paginate()` returns `PaginationResult` with different field names (`page` not `items`, `continueCursor` not `cursor`)
- Gotchas: `listPending` cannot be fully O(page_size) without schema change - artifacts need `workspaceId` field for efficient filtering
---

## 2026-01-09 - claude-agent-sdk-experiments-2rb
- Denormalized workspaceId onto artifacts table to eliminate N+1 query in listPending
- Files changed:
  - `convex/schema.ts`: Added `workspaceId` field and `by_workspace_review` composite index
  - `convex/artifacts.ts`: Updated `create` to populate workspaceId from sandboxRun access
  - `convex/artifacts.ts`: Updated `internalCreate` to accept workspaceId parameter
  - `convex/artifacts.ts`: Simplified `listPending` to single index query (was 60+ lines of iterative pagination)
  - `convex/artifacts.ts`: Added `backfillWorkspaceId` internal mutation for existing data
- Learnings: Type assertion `(artifact as { workspaceId?: unknown }).workspaceId` needed for backfill of optional-in-runtime field
- Performance: Query now O(1) database reads regardless of pending artifact count
---

## 2026-01-09 - claude-agent-sdk-experiments-xoi
- Fixed race condition in concurrent status updates
- Files changed:
  - `convex/sandboxRuns.ts`: Refactored `performSandboxRunUpdate` to re-fetch document state before patching
  - `convex/sandboxRuns.ts`: Added `UpdateResult` type with `{updated, skipped, reason}`
  - `convex/sandboxRuns.ts`: Added `skipTerminalStates` option to `internalUpdate` for graceful cron handling
  - `convex/actions/killIdleSandboxes.ts`: Use `skipTerminalStates: true`, track skipped count in logs
- Learnings: Authorization checks may stale-read document state; always re-fetch before state-dependent operations
- Gotchas: Cron job queries can return sandboxes that complete between query and update - handle with `skipTerminalStates`
---

## 2026-01-09 - claude-agent-sdk-experiments-i8i
- Added FK validation to internal mutations to prevent orphaned records
- Files changed:
  - `convex/sandboxRuns.ts`: Added workspace existence check in `internalCreate`
  - `convex/artifacts.ts`: Added sandbox run and workspace existence checks in `internalCreate`
  - `convex/artifacts.ts`: Added workspace consistency check (sandbox run must belong to specified workspace)
- Learnings: Internal mutations bypass auth but still need data integrity checks
- Error messages include the invalid ID for debugging: `Workspace not found: ${args.workspaceId}`
---

## 2026-01-09 - claude-agent-sdk-experiments-94t
- Fixed admin role escalation vulnerability in workspaceMembers.ts
- Files changed:
  - `convex/workspaceMembers.ts`: updateRole now requires owner for admin promotion/demotion
  - `convex/workspaceMembers.ts`: removeMember now requires owner to remove admin members
- Security: Only owners can change admin privileges (promote to admin, demote from admin, or remove admin)
- Pattern: Capture `requireWorkspaceMembership` return value to check caller's role for secondary authorization
- Error messages follow existing pattern: "Unauthorized: only owners can..."
---

## 2026-01-09 - claude-agent-sdk-experiments-176
- Fixed cascade deletion timeout by batching operations with Promise.all
- Files changed:
  - `convex/workspaces.ts`: Refactored `remove` mutation to use parallel queries and deletes
- Strategy:
  1. Query sandboxRuns and members in parallel
  2. Query artifacts per run in parallel
  3. Delete all artifacts in parallel (step completes before next)
  4. Delete all sandboxRuns in parallel
  5. Delete all members in parallel
  6. Delete workspace
- Learnings: Promise.all for batch deletes maintains order when awaited sequentially between steps
- Performance: O(4) round-trips instead of O(runs + artifacts + members) for large workspaces
---

## 2026-01-09 - claude-agent-sdk-experiments-dzq
- Fixed type duplication by deriving types from validators using Convex's Infer
- Files changed:
  - `convex/lib/validators.ts`: Added `SandboxStatus` and `MemberRole` types using `Infer<typeof validator>`
  - `convex/lib/stateMachine.ts`: Import and re-export `SandboxStatus` from validators (removed inline type definition)
  - `convex/lib/authorization.ts`: Import and re-export `MemberRole` from validators (removed inline type definition)
  - `convex/sandboxRuns.ts`: Removed `as SandboxStatus` casts, updated `SandboxRunUpdateArgs` type
- Learnings: Re-export types with `export type { TypeName }` for backward compatibility with existing imports
- Benefits: TypeScript now catches type mismatches at compile time; single source of truth eliminates drift
---

## 2026-01-09 - claude-agent-sdk-experiments-azs
- Standardized authorization patterns across all files to use shared helpers
- Files changed:
  - `convex/workspaces.ts`: Use `getUserMembership` in `get` query (removed inline filter)
  - `convex/workspaceMembers.ts`: Use `by_workspace_user` composite index in `addMember`, `removeMember`, `updateRole`
  - `convex/workspaceMembers.ts`: Use `getUserMembership` in `listMembers` for auth check
  - `convex/sandboxRuns.ts`: Use `getUserMembership` in `create` mutation
- Learnings: All membership lookups should use `by_workspace_user` composite index for O(1) lookup
- Pattern: `getUserMembership` returns null (for queries), `requireWorkspaceMembership` throws (for mutations)
---

## 2026-01-09 - claude-agent-sdk-experiments-0dd
- Updated internalFindIdle to use by_status_activity composite index for better query performance
- Files changed:
  - `convex/sandboxRuns.ts`: Refactored internalFindIdle to use composite index with range query
- Before: Fetched all "running" sandboxes with by_status, then filtered lastActivityAt in memory
- After: Uses by_status_activity with `.eq("status", "running").lt("lastActivityAt", cutoffTime)` to filter at index level
- Only remaining in-memory filter: sandboxId !== undefined check (cannot be indexed efficiently)
- Performance: Database now returns only relevant results instead of all running sandboxes
---

## 2026-01-09 - claude-agent-sdk-experiments-7ip
- Removed unused DEFAULT_MAX_DURATION_MS constant and replaced hardcoded idle timeout with shared constant
- Files changed:
  - `convex/lib/constants.ts`: Removed unused DEFAULT_MAX_DURATION_MS constant
  - `convex/actions/startSandboxRun.ts`: Import and use IDLE_TIMEOUT_MS instead of hardcoded value
- Learnings: Keep constants.ts lean - only export constants that are actually used
- Benefits: Single source of truth for timeout values, easier to modify across codebase
---

## 2026-01-09 - claude-agent-sdk-experiments-oir
- Added input length validation on string fields to prevent storage abuse
- Files changed:
  - `convex/lib/constants.ts`: Added MAX_NAME_LENGTH, MAX_TITLE_LENGTH, MAX_THREAD_ID_LENGTH, MAX_ERROR_* constants
  - `convex/lib/validators.ts`: Added validateStringLength, validateName, validateTitle, validateThreadId, validateError helpers
  - `convex/workspaces.ts`: Added validateName in create and update mutations
  - `convex/artifacts.ts`: Added validateTitle/validateThreadId in create and internalCreate
  - `convex/sandboxRuns.ts`: Added validateThreadId in create/internalCreate, validateError in update/internalUpdate
- Pattern: Validate input lengths early (before DB queries) to fail fast
- Limits: name ≤100, title ≤200, threadId ≤100, error.message ≤1000, error.code ≤50, error.details ≤2000
---

## 2026-01-09 - claude-agent-sdk-experiments-fhd
- Added cancelSandboxRun action for user-facing cancellation
- Files changed:
  - `convex/sandboxRuns.ts`: Added `internalGet` query for action use
  - `convex/actions/cancelSandboxRun.ts`: New action that handles complete cancellation workflow
- Implementation:
  1. Verifies user authentication
  2. Fetches sandbox run via internalGet
  3. Checks workspace membership via internalGetMembership
  4. Kills E2B sandbox via Sandbox.connect().kill() (gracefully handles already-dead sandboxes)
  5. Updates status to 'canceled' with finishedAt via internalUpdate
- Pattern: Actions use internal queries/mutations - internalGet for fetching, internalGetMembership for auth
- Uses skipTerminalStates to prevent race condition errors when sandbox completes between query and update
---


## 2026-01-09 - claude-agent-sdk-experiments-4x9
- Extracted pagination helper for DRY empty result pattern
- Files changed:
  - `convex/lib/pagination.ts`: New file with `emptyPaginationResult<T>()` generic helper
  - `convex/sandboxRuns.ts`: Use helper in `listByWorkspace` query
  - `convex/artifacts.ts`: Use helper in `listByRun` and `listPending` queries
- Pattern: Use `emptyPaginationResult<Doc<"tableName">>()` instead of inline `{ page: [], continueCursor: "", isDone: true }`
- Benefits: Single source of truth, clear intent, type-safe, consistent behavior
---
