# Progress Log

## Codebase Patterns
- Convex init command is deprecated; use `npx convex dev --once --configure=new` or create structure manually
- For local-only development without deployment, create stub _generated files manually
- Convex requires `npx convex dev` running to regenerate types; stub files enable offline typechecking
- Pre-existing TypeScript errors exist in examples/ folder - not blocking Convex work

## Key Files
- convex/convex.config.ts - Convex app configuration with @convex-dev/agent component
- convex/schema.ts - Convex database schema definition
- convex/_generated/ - Auto-generated type definitions (can be stubbed for local dev)
- convex/tsconfig.json - TypeScript config for Convex functions
- convex/lib/stateMachine.ts - State machine for sandbox run status transitions
- convex/lib/constants.ts - Shared timeout constants (IDLE_TIMEOUT_MS, BOOT_TIMEOUT_MS, DEFAULT_MAX_DURATION_MS)
- convex/lib/validators.ts - Shared Convex validators (sandboxStatusValidator, artifactTypeValidator, reviewStateValidator, memberRoleValidator)
- convex/lib/authorization.ts - Shared authorization helpers (getUserMembership, requireWorkspaceMembership, getSandboxRunAccess, getArtifactAccess)
- convex/sandboxRuns.ts - CRUD mutations for sandbox runs with state validation
- convex/artifacts.ts - CRUD mutations for artifacts with HITL review workflow
- convex/actions/startSandboxRun.ts - E2B sandbox creation action with 'use node' directive
- convex/actions/killIdleSandboxes.ts - Cron action to kill idle E2B sandboxes
- convex/crons.ts - Cron job definitions (killIdleSandboxes runs every 30s)
- autonomous/prd.json - Story tracking for autonomous agent

---

## 2026-01-08 - US-001
- Installed convex (^1.31.3) and @convex-dev/agent (^0.3.2) packages
- Created convex/ directory with base structure
- Created convex/_generated/ with stub type files (api.d.ts, api.js, dataModel.d.ts, server.d.ts, server.js)
- Created minimal convex/schema.ts as foundation for future tables
- Files changed: package.json, package-lock.json, convex/* (new)
- Gotcha: `npx convex init` is deprecated - manual setup or `convex dev --once` required
- Gotcha: _generated folder requires live deployment to auto-generate; stub files work for local typecheck
---

## 2026-01-08 - US-002
- Created convex/convex.config.ts to configure @convex-dev/agent component
- Imports defineApp from convex/server
- Imports agent from @convex-dev/agent/convex.config
- Calls app.use(agent) to install agent component with threads, messages, streaming
- Exports default app configuration
- Updated _generated files with components export for agent integration
- Files changed: convex/convex.config.ts (new), convex/_generated/* (updated)
- Convex folder typechecks cleanly; pre-existing examples/ errors remain (documented as non-blocking)
---

## 2026-01-08 - US-003
- Created complete Convex schema with 4 custom tables
- workspaces: name, ownerId, createdAt (multi-tenant container)
- workspaceMembers: workspaceId, userId, role, joinedAt with indexes (by_user, by_workspace)
- sandboxRuns: Full E2B tracking with state machine (booting/running/succeeded/failed/canceled)
  - Fields: threadId, workspaceId, createdBy, sandboxId, status, startedAt, finishedAt, lastActivityAt, maxDurationMs, idleTimeoutMs, e2bCost, error
  - Indexes: by_thread, by_workspace, by_status
- artifacts: HITL artifact review workflow
  - Fields: sandboxRunId, threadId, type, title, storageId, contentType, size, sandboxPath, previewText, reviewState, reviewedBy, reviewedAt, createdAt
  - Type: file/image/code/log/other
  - ReviewState: pending/approved/rejected
  - Indexes: by_run, by_thread, by_review_state
- Files changed: convex/schema.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-004
- Created convex/workspaces.ts with full CRUD operations for workspaces table
- Mutations:
  - create: takes name, returns workspace Id, also creates owner membership entry
  - update: takes workspaceId and name, validates owner-only access
  - remove: takes workspaceId, deletes all members first, then workspace
- Queries:
  - get: takes workspaceId, returns workspace or null (validates access)
  - list: returns all workspaces for current user (owned + member)
- All functions use ctx.auth.getUserIdentity() for authentication
- Owner-only validation for update/remove mutations
- Files changed: convex/workspaces.ts (new)
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-005
- Created convex/workspaceMembers.ts with full member management operations
- Mutations:
  - addMember: takes workspaceId, userId, role (admin/member), validates owner/admin access
  - removeMember: takes workspaceId, userId, prevents owner removal
  - updateRole: takes workspaceId, userId, newRole, prevents owner role change
- Queries:
  - listMembers: takes workspaceId, returns all members (requires membership)
  - getUserWorkspaces: returns workspaces with user's role in each
- Role validation: only owner or admin can add/remove/update members
- Helper functions: getUserMembership, canManageMembers
- All functions use ctx.auth.getUserIdentity() for authentication
- Files changed: convex/workspaceMembers.ts (new)
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-006
- Created convex/lib/stateMachine.ts for sandbox run status transitions
  - VALID_TRANSITIONS constant mapping current status to allowed next statuses
  - booting -> running, failed, canceled
  - running -> succeeded, failed, canceled
  - succeeded, failed, canceled are terminal states (no transitions)
  - validateTransition(from, to) returns boolean for validity check
  - isTerminalStatus and getTransitionError helper functions
  - SandboxStatus type definition for type safety
- Created convex/sandboxRuns.ts with mutations
  - create: takes threadId, workspaceId, status, returns sandboxRunId
    - Validates user authentication and workspace membership
    - Sets startedAt and lastActivityAt to current time
    - Optional maxDurationMs and idleTimeoutMs parameters
  - update: takes sandboxRunId and partial fields
    - Validates status transitions using state machine
    - Throws descriptive error on invalid transition
    - Supports: sandboxId, status, finishedAt, lastActivityAt, e2bCost, error
- Files changed: convex/lib/stateMachine.ts (new), convex/sandboxRuns.ts (new)
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-007
- Added sandboxRun queries to convex/sandboxRuns.ts
- Queries:
  - get: takes sandboxRunId, returns run document or null
  - listByWorkspace: takes workspaceId, returns runs using by_workspace index
  - listByThread: takes threadId, returns runs using by_thread index
  - findIdle: takes maxIdleMs, returns idle running sandboxes for cleanup
- findIdle implementation:
  - Queries sandboxRuns by status 'running' using by_status index
  - Filters out runs without sandboxId (sandbox not yet created)
  - Compares lastActivityAt against cutoff (now - maxIdleMs)
  - Critical for cron cleanup job in US-009
- Files changed: convex/sandboxRuns.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-008
- Created convex/actions/startSandboxRun.ts - Core E2B integration action
- Action features:
  - Uses "use node" directive for Node.js runtime
  - Takes threadId, workspaceId, prompt, optional maxDurationMs
  - Creates sandboxRun record with status 'booting' via internalCreate
  - Creates E2B sandbox using Sandbox.create() with metadata
  - Updates sandboxRun with sandboxId and status 'running' on success
  - On error: updates status to 'failed' with detailed error object
  - Cleans up partially created sandbox on failure
- Added internal mutations to sandboxRuns.ts:
  - internalCreate: creates sandboxRun without auth checks (for action use)
  - internalUpdate: updates sandboxRun without auth checks (for action use)
- Updated _generated/api.d.ts with proper type definitions for internal mutations
- Pattern: Actions use internal mutations, public mutations validate auth
- Files changed: convex/actions/startSandboxRun.ts (new), convex/sandboxRuns.ts, convex/_generated/api.d.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-009
- Created convex/actions/killIdleSandboxes.ts - Idle sandbox cleanup action
- Action features:
  - Uses "use node" directive for Node.js runtime
  - Queries internalFindIdle with 15 minute idle timeout (15 * 60 * 1000 ms)
  - Connects to each idle sandbox using Sandbox.connect(sandboxId)
  - Kills sandbox with sandbox.kill()
  - Updates run status to 'canceled' with finishedAt timestamp
  - Graceful error handling: continues processing if sandbox already dead
  - Returns { killed: number, errors: number } for observability
- Created convex/crons.ts with cronJobs()
  - Schedules killIdleSandboxes every 30 seconds via crons.interval()
  - Prevents runaway E2B sandbox costs
- Added internalFindIdle query to sandboxRuns.ts:
  - Internal version of findIdle for use by actions
  - Same logic: finds running sandboxes with sandboxId where idle > maxIdleMs
- Updated _generated/api.d.ts with:
  - SandboxRunsInternalFindIdle type for internal query
  - KillIdleSandboxesAction type for the cleanup action
  - Expanded internal object with actions.killIdleSandboxes namespace
- Pattern: Cron jobs invoke internal actions which use internal queries/mutations
- Files changed: convex/actions/killIdleSandboxes.ts (new), convex/crons.ts (new), convex/sandboxRuns.ts, convex/_generated/api.d.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-010
- Created convex/artifacts.ts with full CRUD operations for artifacts table
- Mutations:
  - create: Creates artifact with sandboxRunId, threadId, type, title, storageId,
    contentType, size, optional sandboxPath and previewText
    - Sets reviewState to 'pending' by default
    - Validates user auth and sandbox run exists
  - updateReviewState: Updates reviewState (pending/approved/rejected)
    - Sets reviewedBy and reviewedAt automatically
    - Supports HITL (human-in-the-loop) review workflow
- Queries:
  - get: Returns artifact by ID or null
  - listByRun: Returns all artifacts for a sandboxRunId using by_run index
  - listPending: Returns artifacts with reviewState 'pending' using by_review_state index
- Follows existing patterns from sandboxRuns.ts for consistency
- All functions use ctx.auth.getUserIdentity() for authentication
- Files changed: convex/artifacts.ts (new)
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-011
- Updated project configuration files for Convex integration
- .env.example changes:
  - Added CONVEX_URL variable with dashboard instructions
  - Added CONVEX_DEPLOY_KEY variable (commented) for CI/CD pipelines
- CLAUDE.md Architecture section:
  - Updated diagram to show Convex backend alongside E2B Cloud
  - Added "Convex Backend Integration" section explaining data flows
- CLAUDE.md Project Structure:
  - Added complete convex/ directory with all files documented
  - Includes _generated/, actions/, lib/, and root-level files
- CLAUDE.md Common Development Tasks:
  - Added "Convex Development" section with npx convex commands
  - Documents tables and state machine overview
- Files changed: .env.example, CLAUDE.md
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-012
- Created convex/lib/constants.ts with shared timeout constants
- Exports:
  - IDLE_TIMEOUT_MS = 15 * 60 * 1000 (15 minutes for idle sandbox cleanup)
  - BOOT_TIMEOUT_MS = 5 * 60 * 1000 (5 minutes for stuck boot detection)
  - DEFAULT_MAX_DURATION_MS = 2 * 60 * 1000 (2 minutes default run timeout)
- JSDoc comments explain purpose of each constant
- Files changed: convex/lib/constants.ts (new)
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-013
- Created convex/lib/validators.ts with shared Convex validators
- Exports:
  - sandboxStatusValidator: booting, running, succeeded, failed, canceled
  - artifactTypeValidator: file, image, code, log, other
  - reviewStateValidator: pending, approved, rejected
  - memberRoleValidator: owner, admin, member
- All validators use v.union() and v.literal() from convex/values
- JSDoc comments explain purpose of each validator
- Single source of truth for enum-like values used in schema and mutations
- Files changed: convex/lib/validators.ts (new)
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-015
- Added missing schema indexes for efficient authorization queries
- New indexes:
  - workspaces.by_owner on [ownerId] - enables fast owner lookups
  - workspaceMembers.by_workspace_user on [workspaceId, userId] - O(1) membership checks
  - sandboxRuns.by_status_activity on [status, lastActivityAt] - optimized idle detection
- All existing indexes preserved (by_user, by_workspace, by_thread, by_status, by_run, by_review_state)
- Updated _generated/api.d.ts via convex dev --typecheck=enable --once
- Files changed: convex/schema.ts, convex/_generated/api.d.ts
- Convex folder typechecks cleanly; convex dev --typecheck=enable --once passes
- These indexes enable the upcoming US-014 shared authorization module
---

## 2026-01-08 - US-014
- Created convex/lib/authorization.ts with shared authorization helpers
- Exports:
  - getUserMembership(ctx, workspaceId): Returns Doc<"workspaceMembers"> or null
    - Uses by_workspace_user composite index for O(1) lookup
  - requireWorkspaceMembership(ctx, workspaceId, requiredRoles?): Returns membership or throws
    - Validates authentication, membership, and optional role requirements
  - getSandboxRunAccess(ctx, sandboxRunId): Returns {sandboxRun, membership} or null
    - Fetches sandbox run and verifies workspace membership
  - getArtifactAccess(ctx, artifactId): Returns {artifact, sandboxRun, membership} or null
    - Fetches artifact, its sandbox run, and verifies workspace membership
- Uses proper TypeScript types: QueryCtx, MutationCtx from convex/_generated/server
- Defines AuthContext union type for flexibility in query and mutation handlers
- Exports MemberRole type ("owner" | "admin" | "member") and interface types for access results
- Files changed: convex/lib/authorization.ts (new)
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-016
- Added authorization to sandboxRuns mutations and queries
- Changes:
  - sandboxRuns.update: Now uses getSandboxRunAccess, throws if null
  - sandboxRuns.get: Now uses getSandboxRunAccess, returns null if unauthorized
  - sandboxRuns.listByWorkspace: Now uses getUserMembership, returns [] if null
  - sandboxRuns.listByThread: Now checks auth and filters runs by user's workspace memberships
  - Removed public findIdle query (security risk - exposed all running sandboxes)
  - Only internalFindIdle remains for cron job use
- Imported getUserMembership and getSandboxRunAccess from ./lib/authorization
- Files changed: convex/sandboxRuns.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-017
- Added authorization to artifacts mutations and queries
- Changes:
  - artifacts.create: Now uses getSandboxRunAccess, throws if null
  - artifacts.updateReviewState: Now uses getArtifactAccess, throws if null
  - artifacts.updateReviewState: Added role check - only owner/admin can review
  - artifacts.get: Now uses getArtifactAccess, returns null if unauthorized
  - artifacts.listByRun: Now uses getSandboxRunAccess, returns [] if null
  - artifacts.listPending: Now REQUIRES workspaceId argument
  - artifacts.listPending: Filters to workspace only via getUserMembership
  - Added internalCreate mutation for actions (bypasses auth)
- Imported getUserMembership, getSandboxRunAccess, getArtifactAccess from ./lib/authorization
- Files changed: convex/artifacts.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-018 (also completes US-022)
- Added workspace membership check to startSandboxRun action
- Changes to convex/actions/startSandboxRun.ts:
  - Added call to internal.workspaceMembers.internalGetMembership BEFORE creating sandbox run
  - Throws "Unauthorized: must be a workspace member" if membership is null
  - Check happens before any database records are created
- Added internalGetMembership query to convex/workspaceMembers.ts (satisfies US-022):
  - Uses internalQuery (not public query)
  - Takes workspaceId (Id<"workspaces">) and userId (string) as arguments
  - Returns Doc<"workspaceMembers"> or null
  - Uses by_workspace_user composite index for O(1) lookup
  - Imported internalQuery from ./_generated/server
  - Imported Doc from ./_generated/dataModel
- Files changed: convex/workspaceMembers.ts, convex/actions/startSandboxRun.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
- Security: Prevents unauthorized users from creating sandbox runs (critical P1 fix)
---

## 2026-01-08 - US-019
- Fixed cascade delete on workspace removal to prevent orphaned records
- Updated convex/workspaces.ts remove mutation:
  - Now deletes ALL sandboxRuns for workspace BEFORE deleting workspace
  - Deletes ALL artifacts for each sandboxRun BEFORE deleting the run
  - Deletion order: artifacts -> sandboxRuns -> workspaceMembers -> workspace
  - Uses by_workspace index to find sandboxRuns
  - Uses by_run index to find artifacts for each run
  - Storage blobs left for Convex GC (no manual deletion needed)
- Files changed: convex/workspaces.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
- Data integrity: Prevents orphaned artifacts and sandboxRuns when workspace is deleted
---

## 2026-01-08 - US-020
- Added boot timeout cleanup to cron job to clean up stuck booting sandboxes
- Changes to convex/sandboxRuns.ts:
  - Added internalFindStuckBooting query to find sandboxes stuck in 'booting' state
  - Query returns sandboxes where status='booting' AND startedAt < (now - maxBootMs)
  - Uses by_status index for efficient lookup
- Changes to convex/actions/killIdleSandboxes.ts:
  - Imports IDLE_TIMEOUT_MS and BOOT_TIMEOUT_MS from lib/constants (removed hardcoded value)
  - Queries both internalFindIdle AND internalFindStuckBooting in parallel using Promise.all
  - Combines results with deduplication by _id using Map
  - Processing uses Promise.allSettled with batches of 10 for parallelization
  - Updated JSDoc and logging to reflect both idle and stuck booting sandboxes
- Files changed: convex/sandboxRuns.ts, convex/actions/killIdleSandboxes.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
- Pattern: Batch parallelization with Promise.allSettled provides efficient processing while handling errors gracefully
---

## 2026-01-08 - US-021
- Restricted admin privilege escalation in workspaceMembers.addMember mutation
- Changes to convex/workspaceMembers.ts:
  - Added check: if args.role === "admin", verify current user is owner
  - Only workspace owners can add members with admin role
  - Admins can still add members with 'member' role
  - Throws "Unauthorized: only owners can add admin members" if admin tries to add admin
- Check happens after canManageMembers but before checking if user already exists
- Uses existing getUserMembership helper to fetch current user's role
- Files changed: convex/workspaceMembers.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
- Security: Prevents admin proliferation where admins could create more admins
---

## 2026-01-08 - US-023
- Deduplicated sandboxRuns update logic to reduce maintenance burden
- Created performSandboxRunUpdate helper function (not exported):
  - Handles status transition validation using validateTransition
  - Builds update object using Object.fromEntries with undefined filter
  - Patches the database with the update object
- Refactored update mutation:
  - Auth check via getSandboxRunAccess
  - Calls performSandboxRunUpdate helper after auth check
- Refactored internalUpdate mutation:
  - Fetches sandbox run directly
  - Calls performSandboxRunUpdate helper directly
- Files changed: convex/sandboxRuns.ts, convex/_generated/api.d.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
- Pattern: Object.fromEntries with filter is a clean way to build partial update objects
---

## 2026-01-08 - US-024
- Optimized workspaces.list query to fix N+1 query pattern
- Removed duplicate getUserWorkspaces function from workspaceMembers.ts
- Changes to convex/workspaces.ts:
  - Removed redundant ownership query (memberships already include owner role)
  - Replaced sequential for loop with Promise.all for batch fetching
  - Uses by_user index on workspaceMembers for efficient lookup
  - Proper type narrowing with NonNullable filter for null workspace removal
- Changes to convex/workspaceMembers.ts:
  - Removed getUserWorkspaces function (duplicate of workspaces.list)
- Files changed: convex/workspaces.ts, convex/workspaceMembers.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
- Pattern: Promise.all is preferred over sequential for loops for independent async operations
---

## 2026-01-08 - US-025
- Used shared validators across schema and mutations for single source of truth
- Changes to convex/schema.ts:
  - Imported sandboxStatusValidator, artifactTypeValidator, reviewStateValidator, memberRoleValidator from ./lib/validators
  - Replaced inline v.union(v.literal(...)) for workspaceMembers.role with memberRoleValidator
  - Replaced inline v.union(v.literal(...)) for sandboxRuns.status with sandboxStatusValidator
  - Replaced inline v.union(v.literal(...)) for artifacts.type with artifactTypeValidator
  - Replaced inline v.union(v.literal(...)) for artifacts.reviewState with reviewStateValidator
- Changes to convex/sandboxRuns.ts:
  - Imported sandboxStatusValidator from ./lib/validators
  - Replaced inline status validators in create, update, and internalUpdate mutations
- Changes to convex/artifacts.ts:
  - Imported artifactTypeValidator and reviewStateValidator from ./lib/validators
  - Replaced inline type validator in create and internalCreate mutations
  - Replaced inline reviewState validator in updateReviewState mutation
- Files changed: convex/schema.ts, convex/sandboxRuns.ts, convex/artifacts.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
- Note: workspaceMembers.ts addMember/updateRole still use v.union(v.literal("admin"), v.literal("member")) intentionally (excludes "owner" which cannot be added/changed)
---

## 2026-01-08 - US-026
- Added pagination to list queries to prevent unbounded query results
- Changes to convex/sandboxRuns.ts:
  - Added PaginatedSandboxRuns type: { items: Doc<"sandboxRuns">[]; cursor: string | null }
  - listByWorkspace now accepts optional cursor (string) and limit (number, default 50) args
  - Uses .order("desc") for consistent pagination ordering
  - Implements cursor-based pagination: finds cursor position, slices from there
  - Uses take(limit + 1) pattern to detect hasMore, returns cursor of last item
- Changes to convex/artifacts.ts:
  - Added PaginatedArtifacts type: { items: Doc<"artifacts">[]; cursor: string | null }
  - listByRun now accepts optional cursor and limit args
  - listPending now accepts optional cursor and limit args
  - Both use same pagination pattern as sandboxRuns.listByWorkspace
- Files changed: convex/sandboxRuns.ts, convex/artifacts.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
- Pattern: Cursor-based pagination with slice and hasMore detection is simple but fetches all data; for very large datasets, consider composite indexes with range queries
---
