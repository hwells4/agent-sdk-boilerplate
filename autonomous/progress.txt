# Progress Log

## Codebase Patterns
- Convex init command is deprecated; use `npx convex dev --once --configure=new` or create structure manually
- For local-only development without deployment, create stub _generated files manually
- Convex requires `npx convex dev` running to regenerate types; stub files enable offline typechecking
- Pre-existing TypeScript errors exist in examples/ folder - not blocking Convex work

## Key Files
- convex/convex.config.ts - Convex app configuration with @convex-dev/agent component
- convex/schema.ts - Convex database schema definition
- convex/_generated/ - Auto-generated type definitions (can be stubbed for local dev)
- convex/tsconfig.json - TypeScript config for Convex functions
- autonomous/prd.json - Story tracking for autonomous agent

---

## 2026-01-08 - US-001
- Installed convex (^1.31.3) and @convex-dev/agent (^0.3.2) packages
- Created convex/ directory with base structure
- Created convex/_generated/ with stub type files (api.d.ts, api.js, dataModel.d.ts, server.d.ts, server.js)
- Created minimal convex/schema.ts as foundation for future tables
- Files changed: package.json, package-lock.json, convex/* (new)
- Gotcha: `npx convex init` is deprecated - manual setup or `convex dev --once` required
- Gotcha: _generated folder requires live deployment to auto-generate; stub files work for local typecheck
---

## 2026-01-08 - US-002
- Created convex/convex.config.ts to configure @convex-dev/agent component
- Imports defineApp from convex/server
- Imports agent from @convex-dev/agent/convex.config
- Calls app.use(agent) to install agent component with threads, messages, streaming
- Exports default app configuration
- Updated _generated files with components export for agent integration
- Files changed: convex/convex.config.ts (new), convex/_generated/* (updated)
- Convex folder typechecks cleanly; pre-existing examples/ errors remain (documented as non-blocking)
---

## 2026-01-08 - US-003
- Created complete Convex schema with 4 custom tables
- workspaces: name, ownerId, createdAt (multi-tenant container)
- workspaceMembers: workspaceId, userId, role, joinedAt with indexes (by_user, by_workspace)
- sandboxRuns: Full E2B tracking with state machine (booting/running/succeeded/failed/canceled)
  - Fields: threadId, workspaceId, createdBy, sandboxId, status, startedAt, finishedAt, lastActivityAt, maxDurationMs, idleTimeoutMs, e2bCost, error
  - Indexes: by_thread, by_workspace, by_status
- artifacts: HITL artifact review workflow
  - Fields: sandboxRunId, threadId, type, title, storageId, contentType, size, sandboxPath, previewText, reviewState, reviewedBy, reviewedAt, createdAt
  - Type: file/image/code/log/other
  - ReviewState: pending/approved/rejected
  - Indexes: by_run, by_thread, by_review_state
- Files changed: convex/schema.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-004
- Created convex/workspaces.ts with full CRUD operations for workspaces table
- Mutations:
  - create: takes name, returns workspace Id, also creates owner membership entry
  - update: takes workspaceId and name, validates owner-only access
  - remove: takes workspaceId, deletes all members first, then workspace
- Queries:
  - get: takes workspaceId, returns workspace or null (validates access)
  - list: returns all workspaces for current user (owned + member)
- All functions use ctx.auth.getUserIdentity() for authentication
- Owner-only validation for update/remove mutations
- Files changed: convex/workspaces.ts (new)
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-005
- Created convex/workspaceMembers.ts with full member management operations
- Mutations:
  - addMember: takes workspaceId, userId, role (admin/member), validates owner/admin access
  - removeMember: takes workspaceId, userId, prevents owner removal
  - updateRole: takes workspaceId, userId, newRole, prevents owner role change
- Queries:
  - listMembers: takes workspaceId, returns all members (requires membership)
  - getUserWorkspaces: returns workspaces with user's role in each
- Role validation: only owner or admin can add/remove/update members
- Helper functions: getUserMembership, canManageMembers
- All functions use ctx.auth.getUserIdentity() for authentication
- Files changed: convex/workspaceMembers.ts (new)
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---
