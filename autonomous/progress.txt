# Progress Log

## Codebase Patterns
- Convex init command is deprecated; use `npx convex dev --once --configure=new` or create structure manually
- For local-only development without deployment, create stub _generated files manually
- Convex requires `npx convex dev` running to regenerate types; stub files enable offline typechecking
- Pre-existing TypeScript errors exist in examples/ folder - not blocking Convex work

## Key Files
- convex/convex.config.ts - Convex app configuration with @convex-dev/agent component
- convex/schema.ts - Convex database schema definition
- convex/_generated/ - Auto-generated type definitions (can be stubbed for local dev)
- convex/tsconfig.json - TypeScript config for Convex functions
- convex/lib/stateMachine.ts - State machine for sandbox run status transitions
- convex/sandboxRuns.ts - CRUD mutations for sandbox runs with state validation
- convex/artifacts.ts - CRUD mutations for artifacts with HITL review workflow
- convex/actions/startSandboxRun.ts - E2B sandbox creation action with 'use node' directive
- convex/actions/killIdleSandboxes.ts - Cron action to kill idle E2B sandboxes
- convex/crons.ts - Cron job definitions (killIdleSandboxes runs every 30s)
- autonomous/prd.json - Story tracking for autonomous agent

---

## 2026-01-08 - US-001
- Installed convex (^1.31.3) and @convex-dev/agent (^0.3.2) packages
- Created convex/ directory with base structure
- Created convex/_generated/ with stub type files (api.d.ts, api.js, dataModel.d.ts, server.d.ts, server.js)
- Created minimal convex/schema.ts as foundation for future tables
- Files changed: package.json, package-lock.json, convex/* (new)
- Gotcha: `npx convex init` is deprecated - manual setup or `convex dev --once` required
- Gotcha: _generated folder requires live deployment to auto-generate; stub files work for local typecheck
---

## 2026-01-08 - US-002
- Created convex/convex.config.ts to configure @convex-dev/agent component
- Imports defineApp from convex/server
- Imports agent from @convex-dev/agent/convex.config
- Calls app.use(agent) to install agent component with threads, messages, streaming
- Exports default app configuration
- Updated _generated files with components export for agent integration
- Files changed: convex/convex.config.ts (new), convex/_generated/* (updated)
- Convex folder typechecks cleanly; pre-existing examples/ errors remain (documented as non-blocking)
---

## 2026-01-08 - US-003
- Created complete Convex schema with 4 custom tables
- workspaces: name, ownerId, createdAt (multi-tenant container)
- workspaceMembers: workspaceId, userId, role, joinedAt with indexes (by_user, by_workspace)
- sandboxRuns: Full E2B tracking with state machine (booting/running/succeeded/failed/canceled)
  - Fields: threadId, workspaceId, createdBy, sandboxId, status, startedAt, finishedAt, lastActivityAt, maxDurationMs, idleTimeoutMs, e2bCost, error
  - Indexes: by_thread, by_workspace, by_status
- artifacts: HITL artifact review workflow
  - Fields: sandboxRunId, threadId, type, title, storageId, contentType, size, sandboxPath, previewText, reviewState, reviewedBy, reviewedAt, createdAt
  - Type: file/image/code/log/other
  - ReviewState: pending/approved/rejected
  - Indexes: by_run, by_thread, by_review_state
- Files changed: convex/schema.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-004
- Created convex/workspaces.ts with full CRUD operations for workspaces table
- Mutations:
  - create: takes name, returns workspace Id, also creates owner membership entry
  - update: takes workspaceId and name, validates owner-only access
  - remove: takes workspaceId, deletes all members first, then workspace
- Queries:
  - get: takes workspaceId, returns workspace or null (validates access)
  - list: returns all workspaces for current user (owned + member)
- All functions use ctx.auth.getUserIdentity() for authentication
- Owner-only validation for update/remove mutations
- Files changed: convex/workspaces.ts (new)
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-005
- Created convex/workspaceMembers.ts with full member management operations
- Mutations:
  - addMember: takes workspaceId, userId, role (admin/member), validates owner/admin access
  - removeMember: takes workspaceId, userId, prevents owner removal
  - updateRole: takes workspaceId, userId, newRole, prevents owner role change
- Queries:
  - listMembers: takes workspaceId, returns all members (requires membership)
  - getUserWorkspaces: returns workspaces with user's role in each
- Role validation: only owner or admin can add/remove/update members
- Helper functions: getUserMembership, canManageMembers
- All functions use ctx.auth.getUserIdentity() for authentication
- Files changed: convex/workspaceMembers.ts (new)
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-006
- Created convex/lib/stateMachine.ts for sandbox run status transitions
  - VALID_TRANSITIONS constant mapping current status to allowed next statuses
  - booting -> running, failed, canceled
  - running -> succeeded, failed, canceled
  - succeeded, failed, canceled are terminal states (no transitions)
  - validateTransition(from, to) returns boolean for validity check
  - isTerminalStatus and getTransitionError helper functions
  - SandboxStatus type definition for type safety
- Created convex/sandboxRuns.ts with mutations
  - create: takes threadId, workspaceId, status, returns sandboxRunId
    - Validates user authentication and workspace membership
    - Sets startedAt and lastActivityAt to current time
    - Optional maxDurationMs and idleTimeoutMs parameters
  - update: takes sandboxRunId and partial fields
    - Validates status transitions using state machine
    - Throws descriptive error on invalid transition
    - Supports: sandboxId, status, finishedAt, lastActivityAt, e2bCost, error
- Files changed: convex/lib/stateMachine.ts (new), convex/sandboxRuns.ts (new)
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-007
- Added sandboxRun queries to convex/sandboxRuns.ts
- Queries:
  - get: takes sandboxRunId, returns run document or null
  - listByWorkspace: takes workspaceId, returns runs using by_workspace index
  - listByThread: takes threadId, returns runs using by_thread index
  - findIdle: takes maxIdleMs, returns idle running sandboxes for cleanup
- findIdle implementation:
  - Queries sandboxRuns by status 'running' using by_status index
  - Filters out runs without sandboxId (sandbox not yet created)
  - Compares lastActivityAt against cutoff (now - maxIdleMs)
  - Critical for cron cleanup job in US-009
- Files changed: convex/sandboxRuns.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-008
- Created convex/actions/startSandboxRun.ts - Core E2B integration action
- Action features:
  - Uses "use node" directive for Node.js runtime
  - Takes threadId, workspaceId, prompt, optional maxDurationMs
  - Creates sandboxRun record with status 'booting' via internalCreate
  - Creates E2B sandbox using Sandbox.create() with metadata
  - Updates sandboxRun with sandboxId and status 'running' on success
  - On error: updates status to 'failed' with detailed error object
  - Cleans up partially created sandbox on failure
- Added internal mutations to sandboxRuns.ts:
  - internalCreate: creates sandboxRun without auth checks (for action use)
  - internalUpdate: updates sandboxRun without auth checks (for action use)
- Updated _generated/api.d.ts with proper type definitions for internal mutations
- Pattern: Actions use internal mutations, public mutations validate auth
- Files changed: convex/actions/startSandboxRun.ts (new), convex/sandboxRuns.ts, convex/_generated/api.d.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-009
- Created convex/actions/killIdleSandboxes.ts - Idle sandbox cleanup action
- Action features:
  - Uses "use node" directive for Node.js runtime
  - Queries internalFindIdle with 15 minute idle timeout (15 * 60 * 1000 ms)
  - Connects to each idle sandbox using Sandbox.connect(sandboxId)
  - Kills sandbox with sandbox.kill()
  - Updates run status to 'canceled' with finishedAt timestamp
  - Graceful error handling: continues processing if sandbox already dead
  - Returns { killed: number, errors: number } for observability
- Created convex/crons.ts with cronJobs()
  - Schedules killIdleSandboxes every 30 seconds via crons.interval()
  - Prevents runaway E2B sandbox costs
- Added internalFindIdle query to sandboxRuns.ts:
  - Internal version of findIdle for use by actions
  - Same logic: finds running sandboxes with sandboxId where idle > maxIdleMs
- Updated _generated/api.d.ts with:
  - SandboxRunsInternalFindIdle type for internal query
  - KillIdleSandboxesAction type for the cleanup action
  - Expanded internal object with actions.killIdleSandboxes namespace
- Pattern: Cron jobs invoke internal actions which use internal queries/mutations
- Files changed: convex/actions/killIdleSandboxes.ts (new), convex/crons.ts (new), convex/sandboxRuns.ts, convex/_generated/api.d.ts
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---

## 2026-01-08 - US-010
- Created convex/artifacts.ts with full CRUD operations for artifacts table
- Mutations:
  - create: Creates artifact with sandboxRunId, threadId, type, title, storageId,
    contentType, size, optional sandboxPath and previewText
    - Sets reviewState to 'pending' by default
    - Validates user auth and sandbox run exists
  - updateReviewState: Updates reviewState (pending/approved/rejected)
    - Sets reviewedBy and reviewedAt automatically
    - Supports HITL (human-in-the-loop) review workflow
- Queries:
  - get: Returns artifact by ID or null
  - listByRun: Returns all artifacts for a sandboxRunId using by_run index
  - listPending: Returns artifacts with reviewState 'pending' using by_review_state index
- Follows existing patterns from sandboxRuns.ts for consistency
- All functions use ctx.auth.getUserIdentity() for authentication
- Files changed: convex/artifacts.ts (new)
- Convex folder typechecks cleanly via `cd convex && npx tsc --noEmit`
---
