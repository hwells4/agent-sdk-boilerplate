{
  "branchName": "feat/convex-integration",
  "userStories": [
    {
      "id": "US-001",
      "title": "Initialize Convex and install dependencies",
      "acceptanceCriteria": [
        "Run: npx convex init (creates convex/ directory)",
        "Run: npm install convex @convex-dev/agent",
        "convex/ directory exists with _generated/ subfolder",
        "package.json includes convex and @convex-dev/agent as dependencies",
        "npx tsc --noEmit passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Foundation - must complete first"
    },
    {
      "id": "US-002",
      "title": "Configure @convex-dev/agent component",
      "acceptanceCriteria": [
        "File exists: convex/convex.config.ts",
        "File imports defineApp from convex/server",
        "File imports agent from @convex-dev/agent/convex.config.js",
        "File calls app.use(agent)",
        "File exports default app",
        "npx tsc --noEmit passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Installs the agent component with threads, messages, streaming"
    },
    {
      "id": "US-003",
      "title": "Create schema with 4 custom tables",
      "acceptanceCriteria": [
        "File exists: convex/schema.ts",
        "Schema defines workspaces table with: name, ownerId, createdAt",
        "Schema defines workspaceMembers table with: workspaceId, userId, role, joinedAt",
        "Schema defines sandboxRuns table with: threadId, workspaceId, createdBy, sandboxId, status, startedAt, finishedAt, lastActivityAt, maxDurationMs, idleTimeoutMs, e2bCost, error",
        "Schema defines artifacts table with: sandboxRunId, threadId, type, title, storageId, contentType, size, sandboxPath, previewText, reviewState, reviewedBy, reviewedAt, createdAt",
        "workspaceMembers has indexes: by_user, by_workspace",
        "sandboxRuns has indexes: by_thread, by_workspace, by_status",
        "artifacts has indexes: by_run, by_thread, by_review_state",
        "npx tsc --noEmit passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Core data model for multi-tenancy and E2B orchestration"
    },
    {
      "id": "US-004",
      "title": "Create workspace mutations and queries",
      "acceptanceCriteria": [
        "File exists: convex/workspaces.ts",
        "Mutation create: takes name, returns workspace Id",
        "Mutation update: takes workspaceId and name",
        "Mutation remove: takes workspaceId, deletes workspace",
        "Query get: takes workspaceId, returns workspace or null",
        "Query list: returns all workspaces for current user",
        "All functions use ctx.auth for user identification",
        "npx tsc --noEmit passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "CRUD for workspaces table"
    },
    {
      "id": "US-005",
      "title": "Create workspaceMember mutations and queries",
      "acceptanceCriteria": [
        "File exists: convex/workspaceMembers.ts",
        "Mutation addMember: takes workspaceId, userId, role",
        "Mutation removeMember: takes workspaceId, userId",
        "Mutation updateRole: takes workspaceId, userId, newRole",
        "Query listMembers: takes workspaceId, returns all members",
        "Query getUserWorkspaces: returns workspaces current user belongs to",
        "Role validation: only owner/admin can add/remove members",
        "npx tsc --noEmit passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Multi-tenant access control"
    },
    {
      "id": "US-006",
      "title": "Create state machine and sandboxRun mutations",
      "acceptanceCriteria": [
        "File exists: convex/lib/stateMachine.ts",
        "VALID_TRANSITIONS constant defines: booting->running/failed/canceled, running->succeeded/failed/canceled",
        "validateTransition function returns boolean",
        "File exists: convex/sandboxRuns.ts",
        "Mutation create: takes threadId, workspaceId, status, returns sandboxRunId",
        "Mutation update: takes sandboxRunId and partial fields, validates status transitions",
        "Update throws error on invalid status transition",
        "npx tsc --noEmit passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "State machine prevents invalid sandbox state transitions"
    },
    {
      "id": "US-007",
      "title": "Create sandboxRun queries including findIdle",
      "acceptanceCriteria": [
        "Query get: takes sandboxRunId, returns run or null",
        "Query listByWorkspace: takes workspaceId, returns runs",
        "Query listByThread: takes threadId, returns runs",
        "Query findIdle: takes maxIdleMs, returns running sandboxes where (now - lastActivityAt) > maxIdleMs",
        "findIdle only returns runs with status 'running'",
        "findIdle filters out runs without sandboxId",
        "npx tsc --noEmit passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "findIdle is critical for the cron cleanup job"
    },
    {
      "id": "US-008",
      "title": "Create startSandboxRun action",
      "acceptanceCriteria": [
        "File exists: convex/actions/startSandboxRun.ts",
        "Action marked with 'use node' directive",
        "Action takes: threadId, workspaceId, prompt, optional maxDurationMs",
        "Action creates sandboxRun record with status 'booting'",
        "Action creates E2B sandbox using Sandbox.create()",
        "Action updates sandboxRun with sandboxId and status 'running'",
        "On error: updates status to 'failed' with error object",
        "Uses internal mutations (not public)",
        "npx tsc --noEmit passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Core E2B integration - creates and manages sandbox lifecycle"
    },
    {
      "id": "US-009",
      "title": "Create idle timeout cron job",
      "acceptanceCriteria": [
        "File exists: convex/actions/killIdleSandboxes.ts",
        "Action marked with 'use node' directive",
        "Action queries findIdle with 15 minute timeout",
        "Action calls Sandbox.connect() then sandbox.kill() for each idle run",
        "Action updates each run status to 'canceled' with finishedAt",
        "Handles errors gracefully (sandbox may already be dead)",
        "File exists: convex/crons.ts",
        "Cron schedules killIdleSandboxes every 30 seconds",
        "npx tsc --noEmit passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Prevents runaway sandbox costs"
    },
    {
      "id": "US-010",
      "title": "Create artifact mutations and queries",
      "acceptanceCriteria": [
        "File exists: convex/artifacts.ts",
        "Mutation create: takes sandboxRunId, threadId, type, title, storageId, contentType, size, optional sandboxPath, optional previewText",
        "Mutation updateReviewState: takes artifactId, reviewState, sets reviewedBy and reviewedAt",
        "Query get: takes artifactId, returns artifact or null",
        "Query listByRun: takes sandboxRunId, returns artifacts",
        "Query listPending: returns artifacts with reviewState 'pending'",
        "npx tsc --noEmit passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Artifact review workflow for HITL"
    },
    {
      "id": "US-011",
      "title": "Update project configuration files",
      "acceptanceCriteria": [
        ".env.example contains CONVEX_URL variable",
        ".env.example contains CONVEX_DEPLOY_KEY variable (commented, for production)",
        "CLAUDE.md documents Convex integration in Architecture section",
        "CLAUDE.md lists new convex/ files in Project Structure",
        "CLAUDE.md includes Convex development commands",
        "npx tsc --noEmit passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Documentation and configuration updates"
    },
    {
      "id": "US-012",
      "title": "Create shared constants module",
      "acceptanceCriteria": [
        "File exists: convex/lib/constants.ts",
        "Exports IDLE_TIMEOUT_MS = 15 * 60 * 1000 (15 minutes)",
        "Exports BOOT_TIMEOUT_MS = 5 * 60 * 1000 (5 minutes)",
        "Exports DEFAULT_MAX_DURATION_MS = 2 * 60 * 1000 (2 minutes)",
        "npx tsc --noEmit passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Phase 1 Foundation - Extract hardcoded timeout values to shared module"
    },
    {
      "id": "US-013",
      "title": "Create shared validators module",
      "acceptanceCriteria": [
        "File exists: convex/lib/validators.ts",
        "Exports sandboxStatusValidator with: booting, running, succeeded, failed, canceled",
        "Exports artifactTypeValidator with: file, image, code, log, other",
        "Exports reviewStateValidator with: pending, approved, rejected",
        "Exports memberRoleValidator with: owner, admin, member",
        "All validators use v.union() and v.literal() from convex/values",
        "npx tsc --noEmit passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Phase 1 Foundation - Extract repeated validator definitions to single source of truth"
    },
    {
      "id": "US-014",
      "title": "Create shared authorization module",
      "acceptanceCriteria": [
        "File exists: convex/lib/authorization.ts",
        "Exports getUserMembership(ctx, workspaceId) - returns membership or null",
        "Exports requireWorkspaceMembership(ctx, workspaceId, requiredRoles?) - throws if unauthorized",
        "Exports getSandboxRunAccess(ctx, sandboxRunId) - returns {sandboxRun, membership} or null",
        "Exports getArtifactAccess(ctx, artifactId) - returns {artifact, sandboxRun, membership} or null",
        "Uses proper TypeScript types from convex/_generated/server",
        "getUserMembership uses by_workspace_user index (requires US-015 first)",
        "npx tsc --noEmit passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Phase 1 Foundation - Shared authorization helpers with proper types. DEPENDS ON US-015 for composite index."
    },
    {
      "id": "US-015",
      "title": "Add missing schema indexes",
      "acceptanceCriteria": [
        "workspaceMembers table has index: by_workspace_user on [workspaceId, userId]",
        "workspaces table has index: by_owner on [ownerId]",
        "sandboxRuns table has index: by_status_activity on [status, lastActivityAt]",
        "All existing indexes preserved (by_user, by_workspace, by_thread, by_status, by_run, by_review_state)",
        "npx tsc --noEmit passes",
        "npx convex dev --typecheck --once passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": "Phase 1 Foundation - Add composite indexes for efficient queries. MUST complete before US-014."
    },
    {
      "id": "US-016",
      "title": "Add authorization to sandboxRuns mutations and queries",
      "acceptanceCriteria": [
        "sandboxRuns.update mutation calls getSandboxRunAccess and throws if null",
        "sandboxRuns.get query calls getSandboxRunAccess, returns sandboxRun or null",
        "sandboxRuns.listByWorkspace query calls getUserMembership, returns [] if null",
        "sandboxRuns.listByThread query checks auth, filters runs by user's workspace membership",
        "Public findIdle query is REMOVED (lines 231-255), only internalFindIdle remains",
        "Import getUserMembership and getSandboxRunAccess from ./lib/authorization",
        "npx tsc --noEmit passes"
      ],
      "priority": 16,
      "passes": true,
      "notes": "Phase 2 P1 Critical - Fix authorization bypass vulnerabilities in sandboxRuns. DEPENDS ON US-014."
    },
    {
      "id": "US-017",
      "title": "Add authorization to artifacts mutations and queries",
      "acceptanceCriteria": [
        "artifacts.create mutation calls getSandboxRunAccess, throws if null",
        "artifacts.updateReviewState mutation calls getArtifactAccess, throws if null",
        "artifacts.updateReviewState throws if membership.role === 'member' (only owner/admin can review)",
        "artifacts.get query calls getArtifactAccess, returns artifact or null",
        "artifacts.listByRun query calls getSandboxRunAccess, returns [] if null",
        "artifacts.listPending query NOW REQUIRES workspaceId argument",
        "artifacts.listPending calls getUserMembership, filters artifacts to workspace only",
        "New internalCreate mutation added for actions (bypasses auth)",
        "Import authorization helpers from ./lib/authorization",
        "npx tsc --noEmit passes"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Phase 2 P1 Critical - Fix authorization bypass and multi-tenant data leakage. DEPENDS ON US-014."
    },
    {
      "id": "US-018",
      "title": "Add workspace membership check to startSandboxRun action",
      "acceptanceCriteria": [
        "startSandboxRun action calls ctx.runQuery(internal.workspaceMembers.internalGetMembership)",
        "Throws 'Unauthorized: must be a workspace member' if membership is null",
        "Check happens BEFORE creating sandboxRun record",
        "New internalGetMembership query added to workspaceMembers.ts",
        "internalGetMembership uses by_workspace_user index",
        "npx tsc --noEmit passes"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Phase 2 P1 Critical - Prevent unauthorized users from creating sandbox runs. DEPENDS ON US-015, US-022."
    },
    {
      "id": "US-019",
      "title": "Fix cascade delete on workspace removal",
      "acceptanceCriteria": [
        "workspaces.remove mutation deletes ALL sandboxRuns for workspace BEFORE deleting workspace",
        "workspaces.remove mutation deletes ALL artifacts for each sandboxRun BEFORE deleting the run",
        "Deletion order: artifacts -> sandboxRuns -> workspaceMembers -> workspace",
        "Uses by_workspace index to find sandboxRuns",
        "Uses by_run index to find artifacts for each run",
        "Storage blobs are left for Convex GC (no manual deletion needed)",
        "npx tsc --noEmit passes"
      ],
      "priority": 19,
      "passes": true,
      "notes": "Phase 2 P1 Critical - Fix data corruption from orphaned records"
    },
    {
      "id": "US-020",
      "title": "Add boot timeout cleanup to cron job",
      "acceptanceCriteria": [
        "New internalFindStuckBooting query in sandboxRuns.ts",
        "Query returns sandboxes where status='booting' AND startedAt < (now - maxBootMs)",
        "killIdleSandboxes action imports IDLE_TIMEOUT_MS and BOOT_TIMEOUT_MS from lib/constants",
        "killIdleSandboxes queries both internalFindIdle AND internalFindStuckBooting",
        "Both idle and stuck booting sandboxes are processed",
        "Processing uses Promise.allSettled with batches of 10 for parallelization",
        "npx tsc --noEmit passes"
      ],
      "priority": 20,
      "passes": false,
      "notes": "Phase 3 P2 Important - Clean up sandboxes stuck in booting state. DEPENDS ON US-012."
    },
    {
      "id": "US-021",
      "title": "Restrict admin privilege escalation",
      "acceptanceCriteria": [
        "workspaceMembers.addMember checks if args.role === 'admin'",
        "If adding admin, current user's membership.role must be 'owner'",
        "Throws 'Unauthorized: only owners can add admin members' if admin tries to add admin",
        "Members can still be added by both owners and admins",
        "npx tsc --noEmit passes"
      ],
      "priority": 21,
      "passes": false,
      "notes": "Phase 3 P2 Important - Prevent admin proliferation"
    },
    {
      "id": "US-022",
      "title": "Add internal membership query for actions",
      "acceptanceCriteria": [
        "New internalGetMembership query in workspaceMembers.ts",
        "Uses internalQuery (not query)",
        "Takes workspaceId and userId as arguments",
        "Returns Doc<'workspaceMembers'> or null",
        "Uses by_workspace_user index for efficient lookup",
        "npx tsc --noEmit passes"
      ],
      "priority": 22,
      "passes": true,
      "notes": "Phase 3 P2 Important - Required by US-018 for action authorization. DEPENDS ON US-015."
    },
    {
      "id": "US-023",
      "title": "Deduplicate sandboxRuns update logic",
      "acceptanceCriteria": [
        "Helper function performSandboxRunUpdate created (not exported)",
        "Helper handles: fetching run, validating transition, building update object, patching DB",
        "update mutation calls helper after auth check",
        "internalUpdate mutation calls helper directly",
        "Update object built using Object.fromEntries with filter for undefined values",
        "No duplicated code between update and internalUpdate handlers",
        "npx tsc --noEmit passes"
      ],
      "priority": 23,
      "passes": false,
      "notes": "Phase 3 P2 Important - DRY principle, reduce maintenance burden"
    },
    {
      "id": "US-024",
      "title": "Optimize workspaces.list query",
      "acceptanceCriteria": [
        "workspaces.list uses Promise.all for batch fetching workspaces",
        "Removes redundant ownership query (memberships already include owner role)",
        "Uses by_user index on workspaceMembers",
        "Returns workspaces.filter to remove null values with proper type narrowing",
        "getUserWorkspaces function in workspaceMembers.ts is REMOVED (duplicate)",
        "npx tsc --noEmit passes"
      ],
      "priority": 24,
      "passes": false,
      "notes": "Phase 3 P2 Important - Fix N+1 query pattern, remove duplicate function"
    },
    {
      "id": "US-025",
      "title": "Use shared validators across schema and mutations",
      "acceptanceCriteria": [
        "schema.ts imports sandboxStatusValidator from ./lib/validators",
        "schema.ts imports artifactTypeValidator from ./lib/validators",
        "schema.ts imports reviewStateValidator from ./lib/validators",
        "schema.ts imports memberRoleValidator from ./lib/validators",
        "sandboxRuns.ts imports sandboxStatusValidator for mutation args",
        "artifacts.ts imports artifactTypeValidator and reviewStateValidator for mutation args",
        "No inline v.union(v.literal(...)) for status/type/role definitions",
        "npx tsc --noEmit passes"
      ],
      "priority": 25,
      "passes": false,
      "notes": "Phase 4 P3 Nice-to-have - Single source of truth for validators. DEPENDS ON US-013."
    },
    {
      "id": "US-026",
      "title": "Add pagination to list queries",
      "acceptanceCriteria": [
        "sandboxRuns.listByWorkspace accepts optional cursor and limit args",
        "Returns { items: Doc[], cursor: string | null }",
        "Default limit is 50",
        "Uses .order('desc') for consistent ordering",
        "Uses .take(limit + 1) pattern to detect hasMore",
        "artifacts.listByRun accepts optional cursor and limit args",
        "artifacts.listPending accepts optional cursor and limit args",
        "npx tsc --noEmit passes"
      ],
      "priority": 26,
      "passes": false,
      "notes": "Phase 4 P3 Nice-to-have - Prevent unbounded query results"
    },
    {
      "id": "US-027",
      "title": "Remove unused code and duplicates",
      "acceptanceCriteria": [
        "isTerminalStatus function REMOVED from lib/stateMachine.ts (unused)",
        "Local getUserMembership and canManageMembers REMOVED from workspaceMembers.ts (use lib/authorization)",
        "Error details in startSandboxRun.ts sets details: undefined (no stack traces)",
        "No commented-out code remains",
        "grep -r 'isTerminalStatus' convex/ returns no results",
        "npx tsc --noEmit passes"
      ],
      "priority": 27,
      "passes": false,
      "notes": "Phase 4 P3 Nice-to-have - Code cleanup and security hardening"
    }
  ]
}
